name: Log aztec-starter traffic

on:
  schedule:
    # ‚è±Ô∏è CLEANUP: Runs once a week on Sunday, precisely at 00:00 UTC.
    - cron: "0 0 * * 0"
  workflow_dispatch:

jobs:
  aztec-starter-traffic:
    runs-on: ubuntu-latest
    
    # üõ°Ô∏è PERMISSION: Grant explicit write permission for the job. 
    # This is a best practice, even when an external token is used.
    permissions:
      contents: write 

    steps:
      # üöÄ UPGRADE: Use the latest stable checkout version (@v4).
      # Uses the default GITHUB_TOKEN for cloning (read access).
      - uses: actions/checkout@v4 
        with:
          token: ${{ secrets.TRAFFIC_ACTION_TOKEN }}

      # Calculates traffic and clones and stores in CSV file
      - name: GitHub traffic 
        uses: sangonzal/repository-traffic-action@v.0.1.6
        env:
          # Custom token used here for API call access (requires 'repo' scope).
          TRAFFIC_ACTION_TOKEN: ${{ secrets.TRAFFIC_ACTION_TOKEN }}
          REPOSITORY_NAME: "AztecProtocol/aztec-starter"
        
      # Commits files to repository
      - name: Commit changes
        uses: EndBug/add-and-commit@v9 # Use the latest stable version
        with:
          # ü§ñ CONSISTENCY: Use the official GitHub Actions Bot identity.
          author_name: github-actions[bot]
          author_email: github-actions[41898282+github-actions[bot]@users.noreply.github.com]
          message: "docs(traffic): update aztec-starter GitHub traffic data"
          add: "./traffic/*"
          # üîë SECURITY: Pass the custom token explicitly for push access.
          token: ${{ secrets.TRAFFIC_ACTION_TOKEN }}
          # The branch to commit to (using the same branch checked out).
          ref: "traffic-aztec-starter" # Keep the original dedicated branch intent
