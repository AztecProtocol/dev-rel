<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Human Passport Verification</title>
		<script type="module">
			import { createAppKit } from "https://cdn.jsdelivr.net/npm/@reown/appkit@1.7.3/dist/esm/exports/index.js";
			window.createAppKit = createAppKit;
		</script>
		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
					Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans",
					"Helvetica Neue", sans-serif;
				color: #333;
				line-height: 1.6;
				max-width: 600px;
				margin: 0 auto;
				padding: 20px;
			}
			.card {
				background-color: #fff;
				border-radius: 12px;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
				padding: 32px;
				margin-bottom: 24px;
			}
			h1 {
				color: #111;
				margin-top: 0;
			}
			button {
				background-color: #5865f2;
				color: white;
				border: none;
				border-radius: 4px;
				padding: 12px 20px;
				font-size: 16px;
				cursor: pointer;
				margin-top: 16px;
				transition: background-color 0.2s;
			}
			button:hover {
				background-color: #4752c4;
			}
			button:disabled {
				background-color: #99a0e6;
				cursor: not-allowed;
			}
			.status {
				margin-top: 24px;
				padding: 16px;
				border-radius: 8px;
				background-color: #f5f5f5;
			}
			.error {
				background-color: #ffebee;
				color: #c62828;
			}
			.success {
				background-color: #e8f5e9;
				color: #2e7d32;
			}
			.spinner {
				display: inline-block;
				width: 20px;
				height: 20px;
				border: 3px solid rgba(255, 255, 255, 0.3);
				border-radius: 50%;
				border-top-color: #fff;
				animation: spin 1s ease-in-out infinite;
				margin-right: 8px;
			}
			@keyframes spin {
				to {
					transform: rotate(360deg);
				}
			}
			.hidden {
				display: none;
			}
			.steps {
				counter-reset: step;
				margin-top: 32px;
			}
			.step {
				position: relative;
				padding-left: 40px;
				margin-bottom: 24px;
				opacity: 0.5;
			}
			.step:before {
				counter-increment: step;
				content: counter(step);
				position: absolute;
				left: 0;
				top: 0;
				width: 28px;
				height: 28px;
				border-radius: 50%;
				background: #ddd;
				display: flex;
				align-items: center;
				justify-content: center;
				font-weight: bold;
			}
			.step.active {
				opacity: 1;
			}
			.step.active:before {
				background: #5865f2;
				color: white;
			}
			.step.completed:before {
				background: #43a047;
				color: white;
				content: "✓";
			}
		</style>
	</head>
	<body>
		<div class="card">
			<h1>Human Passport Verification</h1>
			<p>
				Connect your wallet and verify your identity to access exclusive
				Discord roles.
			</p>

			<div class="steps">
				<div class="step active" id="step1">
					<h3>Connect Wallet</h3>
					<p>
						Connect your Ethereum wallet to begin the verification
						process.
					</p>
					<button id="connectButton">Connect Wallet</button>
				</div>

				<div class="step" id="step2">
					<h3>Sign Message</h3>
					<p>
						Sign a message to verify your wallet ownership and
						complete the verification.
					</p>
					<button id="signButton" disabled>Sign Message</button>
				</div>

				<div class="step" id="step3">
					<h3>Verification</h3>
					<p>
						We'll check your Human Passport score and assign your
						role if eligible.
					</p>
					<div id="verificationResult"></div>
				</div>
			</div>

			<div id="status" class="status hidden"></div>
		</div>

		<script>
			// Initialize variables
			let sessionId = null;
			let walletAddress = null;
			let messageToSign = null;
			let wallet = null;

			// DOM elements
			const connectButton = document.getElementById("connectButton");
			const signButton = document.getElementById("signButton");
			const statusDiv = document.getElementById("status");
			const verificationResult =
				document.getElementById("verificationResult");
			const step1 = document.getElementById("step1");
			const step2 = document.getElementById("step2");
			const step3 = document.getElementById("step3");

			// API base URL - should be the same domain as this page
			const API_BASE_URL = "/api/passport";

			// Project ID for Reown (this will be dynamically replaced by the server at runtime)
			const REOWN_PROJECT_ID = "{{REOWN_PROJECT_ID}}";

			// Parse the session ID from the URL
			function getSessionId() {
				const urlParams = new URLSearchParams(window.location.search);
				return urlParams.get("session");
			}

			// Show status message
			function showStatus(message, isError = false) {
				statusDiv.textContent = message;
				statusDiv.classList.remove("hidden", "error", "success");
				if (isError) {
					statusDiv.classList.add("error");
				} else {
					statusDiv.classList.add("success");
				}
			}

			// Check if session is valid
			async function checkSession() {
				try {
					sessionId = getSessionId();
					if (!sessionId) {
						showStatus(
							"Invalid session. Please return to Discord and try again.",
							true
						);
						return false;
					}

					const response = await fetch(
						`${API_BASE_URL}/session/${sessionId}`
					);
					const data = await response.json();

					if (!data.success) {
						showStatus(
							"Session expired or invalid. Please return to Discord and try again.",
							true
						);
						return false;
					}

					return true;
				} catch (error) {
					showStatus(
						"Error connecting to server. Please try again later.",
						true
					);
					console.error("Session check error:", error);
					return false;
				}
			}

			// Connect wallet using Reown AppKit
			async function connectWallet() {
				try {
					connectButton.disabled = true;
					connectButton.innerHTML =
						'<span class="spinner"></span> Connecting...';

					// Initialize AppKit
					if (!window.createAppKit) {
						showStatus(
							"Wallet connection library not loaded. Please refresh the page.",
							true
						);
						connectButton.disabled = false;
						connectButton.textContent = "Connect Wallet";
						return;
					}

					const appkit = window.createAppKit({
						projectId: REOWN_PROJECT_ID || "demo-project-id",
					});

					// Connect to the wallet
					const connection = await appkit.connect();

					// If connected successfully
					if (
						connection &&
						connection.accounts &&
						connection.accounts.length > 0
					) {
						walletAddress = connection.accounts[0];
						wallet = connection;

						connectButton.innerHTML = "✓ Connected";
						showStatus(
							`Connected wallet: ${walletAddress.substring(
								0,
								6
							)}...${walletAddress.substring(
								walletAddress.length - 4
							)}`
						);

						// Update steps
						step1.classList.remove("active");
						step1.classList.add("completed");
						step2.classList.add("active");

						// Enable sign button
						signButton.disabled = false;

						// Send wallet address to server
						await connectWalletToSession(walletAddress);
					} else {
						connectButton.disabled = false;
						connectButton.textContent = "Connect Wallet";
						showStatus(
							"Failed to connect wallet. Please try again.",
							true
						);
					}
				} catch (error) {
					connectButton.disabled = false;
					connectButton.textContent = "Connect Wallet";
					showStatus(
						`Error connecting wallet: ${error.message}`,
						true
					);
					console.error("Wallet connection error:", error);
				}
			}

			// Send wallet address to the server
			async function connectWalletToSession(address) {
				try {
					const response = await fetch(
						`${API_BASE_URL}/connect-wallet`,
						{
							method: "POST",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify({
								sessionId: sessionId,
								walletAddress: address,
							}),
						}
					);

					const data = await response.json();

					if (data.success) {
						messageToSign = data.message;
					} else {
						showStatus(`Error: ${data.error}`, true);
						signButton.disabled = true;
					}
				} catch (error) {
					showStatus(
						"Error connecting to server. Please try again later.",
						true
					);
					console.error("API error:", error);
					signButton.disabled = true;
				}
			}

			// Sign message with wallet
			async function signMessage() {
				try {
					if (!messageToSign || !wallet || !walletAddress) {
						showStatus(
							"Unable to sign message. Please reconnect your wallet.",
							true
						);
						return;
					}

					signButton.disabled = true;
					signButton.innerHTML =
						'<span class="spinner"></span> Signing...';
					showStatus(
						"Please approve the signature request in your wallet."
					);

					// Sign the message using Reown AppKit
					const signResult = await window.appkit.request({
						method: "personal_sign",
						params: [messageToSign, walletAddress],
					});

					if (signResult) {
						signButton.innerHTML = "✓ Signed";

						// Update steps
						step2.classList.remove("active");
						step2.classList.add("completed");
						step3.classList.add("active");

						// Send signature to server
						await verifySignature(signResult);
					} else {
						signButton.disabled = false;
						signButton.textContent = "Sign Message";
						showStatus(
							"Failed to sign message. Please try again.",
							true
						);
					}
				} catch (error) {
					signButton.disabled = false;
					signButton.textContent = "Sign Message";
					showStatus(`Error signing message: ${error.message}`, true);
					console.error("Signing error:", error);
				}
			}

			// Send signature to server
			async function verifySignature(signature) {
				try {
					showStatus(
						"Verifying signature and checking Passport score..."
					);

					const response = await fetch(
						`${API_BASE_URL}/verify-signature`,
						{
							method: "POST",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify({
								sessionId: sessionId,
								signature: signature,
							}),
						}
					);

					const data = await response.json();

					// Check verification status
					await checkVerificationStatus();
				} catch (error) {
					showStatus(
						"Error verifying signature. Please try again later.",
						true
					);
					console.error("Verification error:", error);
					verificationResult.innerHTML =
						'<div class="error">Verification failed due to server error.</div>';
				}
			}

			// Check verification status
			async function checkVerificationStatus() {
				try {
					const response = await fetch(
						`${API_BASE_URL}/status/${sessionId}`
					);
					const data = await response.json();

					if (!data.success) {
						showStatus(`Error: ${data.error}`, true);
						verificationResult.innerHTML =
							'<div class="error">Verification status check failed.</div>';
						return;
					}

					// Display the verification result
					if (data.verified && data.roleAssigned) {
						showStatus(
							"Verification successful! Your Discord role has been assigned.",
							false
						);
						verificationResult.innerHTML = `
                        <div class="success">
                            <h3>✓ Verification Complete</h3>
                            <p>Your Passport score: ${data.score}</p>
                            <p>The verified role has been assigned to your Discord account.</p>
                            <p>You can now close this window and return to Discord.</p>
                        </div>
                    `;
					} else if (data.verified) {
						showStatus(
							"Verification successful, but role assignment failed.",
							true
						);
						verificationResult.innerHTML = `
                        <div class="error">
                            <h3>✓ Passport Verified</h3>
                            <p>Your Passport score: ${data.score}</p>
                            <p>However, we couldn't assign the role to your Discord account.</p>
                            <p>Please contact an administrator for assistance.</p>
                        </div>
                    `;
					} else if (data.score !== undefined) {
						showStatus(
							`Verification failed. Your score (${data.score}) is below the required threshold (${data.minimumRequiredScore}).`,
							true
						);
						verificationResult.innerHTML = `
                        <div class="error">
                            <h3>❌ Score Too Low</h3>
                            <p>Your Passport score: ${data.score}</p>
                            <p>Required minimum score: ${data.minimumRequiredScore}</p>
                            <p>Try connecting more verified accounts to your Passport to increase your score and try again.</p>
                        </div>
                    `;
					} else {
						showStatus(
							"Verification in progress. Please wait...",
							false
						);
						verificationResult.innerHTML =
							"<div>Verification in progress...</div>";

						// Poll for status updates
						setTimeout(checkVerificationStatus, 5000);
					}
				} catch (error) {
					showStatus(
						"Error checking verification status. Please try again later.",
						true
					);
					console.error("Status check error:", error);
				}
			}

			// Initialize the page
			async function initialize() {
				const isSessionValid = await checkSession();

				if (isSessionValid) {
					connectButton.addEventListener("click", connectWallet);
					signButton.addEventListener("click", signMessage);
				} else {
					connectButton.disabled = true;
					signButton.disabled = true;
				}
			}

			// Start the application when the page loads
			window.addEventListener("load", initialize);
		</script>
	</body>
</html>
